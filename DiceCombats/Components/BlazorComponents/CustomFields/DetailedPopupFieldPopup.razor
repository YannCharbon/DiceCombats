@*
 * DiceCombats - Copyright (C) 2025 Yann Charbon
 * SPDX-License-Identifier: GPL-3.0-or-later
 *
 * This file is part of DiceCombats, released under the GNU GPL v3.
 * See the LICENSE file in the repository root for details.
*@

@using DiceCombats
@using DiceCombats.Rendering
@using DiceCombats.Rendering.Contracts
@inject DiceCombatsService CombatService
@inject RendererRegistry Renderers
@inject IStringLocalizer<Resources.Localization.DetailedPopupFieldPopup> Loc
@inject IFileHandler FileHandler
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService

<style>
    .DetailedPopupSubFieldBox {
        background-color: #2A2A2A;
        box-shadow: 0 2px 10px rgba(255, 255, 255, 0.1);
        border: 1px solid #808080;
        border-radius: 10px;
        padding: 20px;
        margin: 10px;
    }

    .masonry-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        zoom: 0.85;
    }

    .masonry-item {
        display: block;
        width: calc(50% - 1rem);
        margin-bottom: 1rem;
    }

    @@media screen and (max-width: 768px) {
        .masonry-item {
            width: calc(100% - 1rem);
        }
    }

    @@media screen and (max-width: 480px) {
        .masonry-item {
            width: 100%;
        }
    }

    .chip {
        padding: 5px;
        background-color: darkcyan;
        border-radius: 10px;
        font-size: 20px;
    }

    .group-title {
        margin: 14px 6px 4px 6px;
        font-weight: 700;
        opacity: .85;
    }

    .assist-callout {
        background: #34343e;
        border: 1px solid #5e5e6b;
        border-radius: 10px;
        padding: 14px;
    }

    .kbd {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        background: #2d2d34;
        border: 1px solid #666;
        font-family: monospace;
        font-size: 90%;
    }

    .pick-btn-cell {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        gap: 4px;
    }
</style>

<script>
    window.initializeMasonry = (selector) => {
        const grid = document.querySelector(selector);
        if (grid) {
            new Masonry(grid, {
                itemSelector: '.masonry-item',
                columnWidth: '.masonry-item',
                percentPosition: true,
                gutter: 10
            });
        }
    };
</script>

@if (!string.IsNullOrWhiteSpace(_combinedCss))
{
    <style>
        @_combinedCss
    </style>
}

<h4 style="text-align:center;margin-bottom:10px;">@DetailedPopupField.Title</h4>

@if (EditionMode)
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2" Style="justify-content:space-between;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudSwitch T="bool" @bind-Value="_showEditorHelp" Color="Color.Info" />
            <MudText Typo="Typo.subtitle2">@Loc["DetailedPopupShowEditorHelp"]</MudText>
        </MudStack>
    </MudStack>

    @if (_showEditorHelp)
    {
        <MudExpansionPanels MultiExpansion="true" Dense="true" Elevation="0" Class="mb-3">
            <MudExpansionPanel Text="@Loc["DetailedPopupOverviewTitle"]">
                <div class="assist-callout">
                    @((MarkupString)Loc["DetailedPopupOverviewBody"].Value)
                </div>
            </MudExpansionPanel>

            <MudExpansionPanel Text="@Loc["DetailedPopupTextTitle"]">
                <div class="assist-callout">
                    @((MarkupString)Loc["DetailedPopupTextBody"].Value)
                </div>
            </MudExpansionPanel>

            <MudExpansionPanel Text="@Loc["DetailedPopupMarkdownTitle"]">
                <div class="assist-callout">
                    @((MarkupString)Loc["DetailedPopupMarkdownBody"].Value)
                </div>
            </MudExpansionPanel>

            <MudExpansionPanel Text="@Loc["DetailedPopupPdfTitle"]">
                <div class="assist-callout">
                    @((MarkupString)Loc["DetailedPopupPdfBody"].Value)
                </div>
            </MudExpansionPanel>

            <MudExpansionPanel Text="@Loc["DetailedPopupHtmlHowItWorksTitle"]">
                <div class="assist-callout">
                    @((MarkupString)Loc["DetailedPopupHtmlHowItWorksBody"].Value)
                </div>
            </MudExpansionPanel>

            <MudExpansionPanel Text="@Loc["DetailedPopupHtmlTipsTitle"]">
                <div class="assist-callout">
                    @((MarkupString)Loc["DetailedPopupHtmlTipsBody"].Value)
                </div>
            </MudExpansionPanel>

            <MudExpansionPanel Text="@Loc["DetailedPopupHtmlQuickStartTitle"]">
                <div class="assist-callout">
                    @((MarkupString)Loc["DetailedPopupHtmlQuickStartBody"].Value)
                </div>
            </MudExpansionPanel>

            <MudExpansionPanel Text="@Loc["DetailedPopupTroubleshootingTitle"]">
                <div class="assist-callout">
                    @((MarkupString)Loc["DetailedPopupTroubleshootingBody"].Value)
                </div>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }

    <hr />
}

@if (EditionMode)
{
    @foreach (var entry in DetailedPopupField.Contents)
    {
        <div class="DetailedPopupSubFieldBox">
            <div style="display: flex; justify-content: flex-end;">
                <MudTooltip Text="@Loc["DetailedPopupDeleteTooltip"]">
                    <MudButton StartIcon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               Disabled="entry.ReadOnly"
                               OnClick="() => DeleteContent(entry)">
                        @Loc["DetailedPopupDeleteButton"]
                    </MudButton>
                </MudTooltip>
            </div>

            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudTextField @bind-Value="entry.Name" Label="@Loc["DetailedPopupContentNameLabel"]" Variant="Variant.Outlined" />
                <MudSelect @bind-Value="entry.Kind" Label="@Loc["DetailedPopupKindLabel"]" Variant="Variant.Outlined" Class="kind-select">
                    <MudSelectItem Value="@("text")">@Loc["DetailedPopupKindTextLabel"]</MudSelectItem>
                    <MudSelectItem Value="@("markdown")">@Loc["DetailedPopupKindMarkdownLabel"]</MudSelectItem>
                    <MudSelectItem Value="@("html")">@Loc["DetailedPopupKindHtmlLabel"]</MudSelectItem>
                    <MudSelectItem Value="@("pdf")">@Loc["DetailedPopupKindPdfLabel"]</MudSelectItem>
                </MudSelect>
            </MudStack>

            @* === TEXT === *@
            @if (entry.Kind == "text")
            {
                <MudTextField @bind-Value="entry.Inline"
                              Label="@Loc["DetailedPopupTextContentLabel"]"
                              Variant="Variant.Outlined"
                              AutoGrow MaxLines="20" />
            }
            @* === MARKDOWN === *@
            else if (entry.Kind == "markdown")
            {
                <MudTextField @bind-Value="entry.Inline"
                              Label="@Loc["DetailedPopupMarkdownContentLabel"]"
                              Variant="Variant.Outlined"
                              AutoGrow MaxLines="20" />
            }
            @* === HTML (templated) === *@
            else if (entry.Kind == "html")
            {
                @* Inline help for this entry only *@
                @if (_showEditorHelp)
                {
                    <div class="assist-callout mb-2">
                        @((MarkupString)Loc["DetailedPopupInlineHelpHtml"].Value)
                    </div>
                }

                <MudGrid Class="mt-2">
                    <MudItem xs="12" md="6">
                        <MudTextField Value="@(GetMeta(entry, "selector"))"
                                      ValueChanged="@( (string? v) => SetMeta(entry, "selector", v) )"
                                      Label="@Loc["DetailedPopupSelectorLabel"]"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Value="@(GetMeta(entry, "template"))"
                                      ValueChanged="@( (string? v) => SetMeta(entry, "template", v) )"
                                      Label="@Loc["DetailedPopupTemplateLabel"]"
                                      Variant="Variant.Outlined" AutoGrow MaxLines="20" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Value="@(GetMeta(entry, "css"))"
                                      ValueChanged="@( (string? v) => SetMeta(entry, "css", v) )"
                                      Label="@Loc["DetailedPopupCssLabel"]"
                                      Variant="Variant.Outlined" AutoGrow MaxLines="16" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Value="@(GetMeta(entry, "map.json"))"
                                      ValueChanged="@( (string? v) => SetMeta(entry, "map.json", v) )"
                                      Label="@Loc["DetailedPopupMapJsonLabel"]"
                                      Variant="Variant.Outlined" AutoGrow MaxLines="16" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudRadioGroup T="string"
                                       Value="@GetHtmlSource(entry)"
                                       ValueChanged="@( (string v) => OnHtmlSourceChanged(entry, v) )"
                                       Row="true">
                            <MudRadio T="string" Value="@("inline")">@Loc["DetailedPopupHtmlSourceInlineLabel"]</MudRadio>
                            <MudRadio T="string" Value="@("file")">@Loc["DetailedPopupHtmlSourceFileLabel"]</MudRadio>
                        </MudRadioGroup>
                    </MudItem>

                    @if (GetHtmlSource(entry) == "inline")
                    {
                        <MudItem xs="12">
                            <MudTextField @bind-Value="entry.Inline"
                                          Label="@Loc["DetailedPopupHtmlContentLabel"]"
                                          Variant="Variant.Outlined"
                                          AutoGrow MaxLines="25" />
                        </MudItem>
                    }
                    else
                    {
                        <MudItem xs="12" md="9">
                            <MudTextField @bind-Value="entry.FilePath"
                                          Label="@Loc["DetailedPopupFilePathLabel"]"
                                          ReadOnly="true"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="3" Class="pick-btn-cell">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.UploadFile"
                                       OnClick="() => PickFileAsync(entry)">
                                @Loc["DetailedPopupPickFileButton"]
                            </MudButton>
                            @if (entry.Blob is { Length: > 0 })
                            {
                                <MudText Typo="Typo.caption">
                                    @string.Format(Loc["DetailedPopupLoadedBytesCaption"], entry.Blob.Length)
                                </MudText>
                            }
                        </MudItem>
                    }
                </MudGrid>
            }
            @* === PDF === *@
            else if (entry.Kind == "pdf")
            {
                @if (_showEditorHelp)
                {
                    <div class="assist-callout mb-2">
                        @((MarkupString)Loc["DetailedPopupPdfInlineHelp"].Value)
                    </div>
                }

                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mt-2">
                    <MudTextField @bind-Value="entry.FilePath"
                                  Label="@Loc["DetailedPopupFilePathLabel"]"
                                  ReadOnly="true"
                                  Variant="Variant.Outlined" />
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.UploadFile"
                               OnClick="() => PickFileAsync(entry)">
                        @Loc["DetailedPopupPickFileButton"]
                    </MudButton>
                    @if (entry.Blob is { Length: > 0 })
                    {
                        <MudText Typo="Typo.caption">
                            @string.Format(Loc["DetailedPopupLoadedBytesCaption"], entry.Blob.Length)
                        </MudText>
                    }
                </MudStack>
            }
        </div>
    }

    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Add"
               OnClick="() => DetailedPopupField.AddNewContent()">
        @Loc["DetailedPopupAddNewContentButton"]
    </MudButton>
}
else
{
    <div style="display:flex;flex-direction:row; margin-bottom:10px; gap:15px; margin-bottom:10px;">
        <MudIconButton Variant="Variant.Filled"
                       Color="Color.Dark"
                       Icon="@(DetailedPopupField.RenderModeGridEnabled ? Icons.Material.Filled.GridView : Icons.Material.Filled.FormatListBulleted)"
                       OnClick="ToggleGrid"
                       title="@Loc["DetailedPopupToggleGridTooltip"]" />
        <MudTextField @bind-Value="Query"
                      Placeholder="@Loc["DetailedPopupSearchPlaceholder"]"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true"
                      DebounceInterval="1000" />
    </div>

    @if (DetailedPopupField.RenderModeGridEnabled)
    {
        @foreach (var g in _visibleGroups)
        {
            <div style="margin:10px;"><span class="chip">@g.Title</span></div>
            <div id="masonry-layout-detailed-popup" class="masonry-layout">
                @foreach (var p in g.Pieces)
                {
                    <div class="masonry-item">
                        <div class="DetailedPopupSubFieldBox">
                            @if (!string.IsNullOrWhiteSpace(p.ParentName))
                            {
                                <hr />
                            }
                            @p.UI
                        </div>
                    </div>
                }
            </div>
        }
    }
    else
    {
        @foreach (var g in _visibleGroups)
        {
            <div style="margin:10px;"><span class="chip">@g.Title</span></div>
            @foreach (var p in g.Pieces)
            {
                <div class="DetailedPopupSubFieldBox">
                    @p.UI
                </div>
            }
        }
    }
}

@code {
    [Parameter] public DCCreatureDetailedPopupField DetailedPopupField { get; set; } = default!;
    [Parameter] public bool EditionMode { get; set; } = false;

    private record PieceVM(string? ParentName, string Kind, RenderFragment UI, IIndexedText Index, string? Key);
    private record GroupVM(string Title, string Kind, List<PieceVM> Pieces);

    private readonly List<PieceVM> _allPieces = new();
    private List<GroupVM> _allGroups = new();
    private List<GroupVM> _visibleGroups = new();

    private string _query = string.Empty;
    private string _combinedCss = string.Empty;
    private bool _showEditorHelp = false;

    private string Query
    {
        get => _query;
        set
        {
            var v = value ?? string.Empty;
            if (_query == v) return;
            _query = v;
            _visibleGroups = FilterGroups(_allGroups, _query);
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JSRuntime.InvokeVoidAsync("initializeMasonry", "#masonry-layout-detailed-popup");
    }

    protected override void OnParametersSet()
    {
        if (EditionMode) return;

        _allPieces.Clear();
        _allGroups.Clear();
        _combinedCss = BuildCombinedCss(DetailedPopupField.Contents);

        // Build pieces
        foreach (var e in DetailedPopupField.Contents)
        {
            var item = ToContentItem(e);
            var pieces = Renderers.RenderMany(item);
            foreach (var piece in pieces)
            {
                _allPieces.Add(new PieceVM(
                    ParentName: string.IsNullOrWhiteSpace(e.Name) ? null : e.Name,
                    Kind: e.Kind ?? string.Empty,
                    UI: piece.UI,
                    Index: piece.Index,
                    Key: piece.Key
                ));
            }
        }

        // Group by (Kind + ParentName) for clear delimitation
        var groupMap = new Dictionary<string, GroupVM>();
        foreach (var p in _allPieces)
        {
            var groupTitle = !string.IsNullOrWhiteSpace(p.ParentName)
                ? $"{p.ParentName}"
                : p.Kind.ToUpperInvariant();

            var key = $"{p.Kind}||{p.ParentName}";
            if (!groupMap.TryGetValue(key, out var g))
            {
                g = new GroupVM(groupTitle, p.Kind, new List<PieceVM>());
                groupMap[key] = g;
            }
            g.Pieces.Add(p);
        }
        _allGroups = groupMap.Values.ToList();

        _visibleGroups = FilterGroups(_allGroups, _query);
    }

    private static DiceCombats.Rendering.BasicContentItem ToContentItem(DCCreatureDetailedPopupField.ContentEntry e)
    {
        var meta = e.Meta as IReadOnlyDictionary<string, string>;
        return new DiceCombats.Rendering.BasicContentItem(
            e.Kind, e.Name, e.Blob, e.Inline, e.FilePath, meta ?? new Dictionary<string, string>());
    }

    private static string BuildCombinedCss(IEnumerable<DCCreatureDetailedPopupField.ContentEntry> contents)
    {
        var sb = new System.Text.StringBuilder();
        foreach (var c in contents)
        {
            if (!"html".Equals(c.Kind, System.StringComparison.OrdinalIgnoreCase)) continue;
            if (c.Meta.TryGetValue("css", out var css) && !string.IsNullOrWhiteSpace(css))
                sb.AppendLine(css);
        }
        return sb.ToString();
    }

    private static List<GroupVM> FilterGroups(List<GroupVM> groups, string q)
    {
        if (string.IsNullOrWhiteSpace(q)) return groups;

        var n = Normalize(q);
        var outList = new List<GroupVM>();
        foreach (var g in groups)
        {
            var keepPieces = new List<PieceVM>();

            // Match the group title itself
            if (Normalize(g.Title).Contains(n))
            {
                keepPieces.AddRange(g.Pieces);
            }
            else
            {
                foreach (var p in g.Pieces)
                {
                    // Match parent name / key
                    if ((!string.IsNullOrWhiteSpace(p.ParentName) && Normalize(p.ParentName).Contains(n)) ||
                        (!string.IsNullOrWhiteSpace(p.Key) && Normalize(p.Key).Contains(n)))
                    {
                        keepPieces.Add(p);
                        continue;
                    }

                    // Search in indexed texts
                    foreach (var (_, text) in p.Index.EnumerateDocuments())
                    {
                        if (Normalize(text).Contains(n))
                        {
                            keepPieces.Add(p);
                            break;
                        }
                    }
                }
            }

            if (keepPieces.Count > 0)
                outList.Add(new GroupVM(g.Title, g.Kind, keepPieces));
        }
        return outList;
    }

    private static string Normalize(string s)
    {
        if (string.IsNullOrEmpty(s)) return string.Empty;
        var form = s.Normalize(System.Text.NormalizationForm.FormD);
        var sb = new System.Text.StringBuilder(form.Length);
        foreach (var ch in form)
        {
            var cat = System.Globalization.CharUnicodeInfo.GetUnicodeCategory(ch);
            if (cat != System.Globalization.UnicodeCategory.NonSpacingMark)
                sb.Append(ch);
        }
        return sb.ToString().Normalize(System.Text.NormalizationForm.FormC).ToLowerInvariant();
    }

    private void ToggleGrid()
    {
        DetailedPopupField.RenderModeGridEnabled = !DetailedPopupField.RenderModeGridEnabled;
        StateHasChanged();
    }

    private static string GetMeta(DCCreatureDetailedPopupField.ContentEntry entry, string key)
        => entry.Meta.TryGetValue(key, out var v) ? v ?? string.Empty : string.Empty;

    private static void SetMeta(DCCreatureDetailedPopupField.ContentEntry entry, string key, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            if (entry.Meta.ContainsKey(key)) entry.Meta.Remove(key);
        }
        else
        {
            entry.Meta[key] = value;
        }
    }

    private void OnHtmlSourceChanged(DCCreatureDetailedPopupField.ContentEntry entry, string v)
    {
        SetMeta(entry, "source", string.IsNullOrWhiteSpace(v) ? "inline" : v);
        StateHasChanged();
    }

    private static string GetHtmlSource(DCCreatureDetailedPopupField.ContentEntry entry)
    {
        var v = GetMeta(entry, "source");
        return (v == "file" || v == "inline") ? v : "inline";
    }

    private async Task PickFileAsync(DCCreatureDetailedPopupField.ContentEntry entry)
    {
        try
        {
            var (path, bytes) = await FileHandler.PickFileAsync();
            if (!string.IsNullOrWhiteSpace(path)) entry.FilePath = path;
            if (bytes is { Length: > 0 }) entry.Blob = bytes;
        }
        catch
        {
            // ignore
        }
    }

    private async Task DeleteContent(DCCreatureDetailedPopupField.ContentEntry entry)
    {
        if (entry is null) return;

        var opts = new DialogOptions
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.ExtraSmall,
                FullWidth = true,
            };

        var confirm = await DialogService.ShowMessageBox(
            title: Loc["DetailedPopupDeleteDialogTitle"],
            markupMessage: (MarkupString)Loc["DetailedPopupDeleteDialogMessage"].Value,
            yesText: Loc["DetailedPopupDeleteDialogYes"],
            cancelText: Loc["DetailedPopupDeleteDialogCancel"],
            options: opts
        );

        if (confirm == true)
        {
            DetailedPopupField.Contents.Remove(entry);
            StateHasChanged();
        }
    }
}
